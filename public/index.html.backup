<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1"
  />
  <title>Everybody's News</title>

  <!-- Your CSS bundles (these files are now in /public) -->
  <link rel="stylesheet" href="/bkstyle.css" />
  <link rel="stylesheet" href="/rex-frontend.css" />
  <link rel="stylesheet" href="/rex-modules.css" />

  <style>
    /* Minimal safety styling in case CSS didn’t load */
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#fff; color:#111; }
    header { position: sticky; top: 0; background: #111; color: #fff; padding: 12px 16px; z-index: 50; }
    header .brand { font-weight: 700; letter-spacing:.5px; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }
    .status { font-size: 12px; color:#666; margin: 8px 0 16px; }
    .hero-grid { display: grid; gap: 12px; grid-template-columns: repeat(12, 1fr); }
    .hero-card { position: relative; background:#f4f4f4; border-radius: 10px; overflow: hidden; min-height: 220px; display:flex; }
    .hero-card img { width: 40%; object-fit: cover; }
    .hero-card .meta { padding: 12px; display:flex; flex-direction:column; gap:8px; }
    .hero-card h3 { margin:0; font-size: 18px; line-height:1.25; }
    .hero-card p { margin:0; color:#444; font-size: 14px; line-height:1.3; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden; }
    .row { margin-top: 20px; }
    .pill { display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:4px 8px; border-radius:999px; background:#eee; }
    .pill img { width:16px; height:16px; }
    .time { font-size:12px; color:#666; }
    /* layout: 8-up hero like a news grid */
    .hero-grid .lead { grid-column: span 8; min-height: 360px; }
    .hero-grid .lead img { width: 50%; }
    .hero-grid .side { grid-column: span 4; min-height: 170px; }
    @media (max-width: 960px) {
      .hero-grid { grid-template-columns: 1fr; }
      .hero-grid .lead, .hero-grid .side { grid-column: auto; min-height: 220px; }
      .hero-card img { width: 45%; }
    }

    /* Rex carousel list */
    .rex-list { display:grid; grid-template-columns: repeat(auto-fill, minmax(280px,1fr)); gap:12px; }
    .rex-item { display:flex; gap:10px; background:#fafafa; border:1px solid #eee; border-radius:10px; padding:10px; }
    .rex-item img.thumb { width:120px; height:80px; object-fit:cover; border-radius:8px; background:#eaeaea; }
    .rex-item h4 { margin:0; font-size:16px; line-height:1.25; }
    .muted { color:#666; font-size:12px; }
    .hdr { display:flex; align-items:center; justify-content:space-between; margin: 6px 0 12px; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">Everybody's News</div>
    </div>
  </header>

  <main class="wrap">
    <div id="status" class="status">Loading…</div>

    <!-- HERO SECTION -->
    <section class="row">
      <div class="hdr">
        <h2 style="margin:0;">Top Stories</h2>
        <button id="refreshBtn" aria-label="Refresh" style="cursor:pointer;border:1px solid #ddd;background:#fff;border-radius:8px;padding:6px 10px">Refresh</button>
      </div>
      <div id="hero" class="hero-grid" aria-live="polite"></div>
    </section>

    <!-- REX CAROUSEL SECTION -->
    <section class="row">
      <div class="hdr">
        <h2 style="margin:0;">Rex Carousel</h2>
        <a href="/api/rex-carousel" class="muted">JSON</a>
      </div>
      <div id="rex" class="rex-list" aria-live="polite"></div>
    </section>
  </main>

  <script>
    const fmtTime = (d) => {
      try {
        const dt = new Date(d);
        const now = Date.now();
        const mins = Math.max(1, Math.round((now - dt.getTime()) / 60000));
        if (mins < 60) return mins + 'm ago';
        const hrs = Math.round(mins / 60);
        if (hrs < 24) return hrs + 'h ago';
        const days = Math.round(hrs / 24);
        return days + 'd ago';
      } catch { return ''; }
    };

    function card(article, isLead=false) {
      const img = article.imageUrl || '';
      const safeTitle = article.title || 'Untitled';
      const safeDesc = article.description || '';
      const srcName = article.source || article.author || 'News Source';
      const srcIcon = article.sourceIcon || '';
      const time = fmtTime(article.pubDate);

      return `
        <article class="hero-card ${isLead ? 'lead' : 'side'}">
          ${img ? `<img src="${img}" alt="" loading="lazy">` : ''}
          <div class="meta">
            <a href="${article.link || '#'}" target="_blank" rel="noopener noreferrer">
              <h3>${safeTitle}</h3>
            </a>
            <p>${safeDesc}</p>
            <div style="display:flex; align-items:center; gap:10px; margin-top:auto;">
              <span class="pill">
                ${srcIcon ? `<img src="${srcIcon}" alt="">` : ''} ${srcName}
              </span>
              <span class="time">${time}</span>
            </div>
          </div>
        </article>
      `;
    }

    function rexItem(article) {
      const img = article.imageUrl || '';
      const srcName = article.source || article.author || 'News Source';
      const time = fmtTime(article.pubDate);
      return `
        <article class="rex-item">
          ${img ? `<img class="thumb" src="${img}" alt="" loading="lazy">` : `<div class="thumb" style="width:120px;height:80px;border-radius:8px;background:#eaeaea;"></div>`}
          <div>
            <a href="${article.link || '#'}" target="_blank" rel="noopener noreferrer">
              <h4>${article.title || 'Untitled'}</h4>
            </a>
            <div class="muted">${srcName} · ${time}</div>
          </div>
        </article>
      `;
    }

    async function loadHero() {
      const res = await fetch('/api/news', { cache: 'no-store' });
      const json = await res.json();

      const el = document.getElementById('hero');
      el.innerHTML = '';

      if (!json.articles || json.articles.length === 0) {
        el.innerHTML = `<div class="muted">No hero articles available.</div>`;
        return json;
      }

      // first = lead, rest = sides
      const items = json.articles;
      el.insertAdjacentHTML('beforeend', card(items[0], true));
      for (let i = 1; i < items.length; i++) el.insertAdjacentHTML('beforeend', card(items[i], false));
      return json;
    }

    async function loadRex() {
      const res = await fetch('/api/rex-carousel', { cache: 'no-store' });
      const json = await res.json();

      const el = document.getElementById('rex');
      el.innerHTML = '';

      if (!json.articles || json.articles.length === 0) {
        el.innerHTML = `<div class="muted">No rex articles available.</div>`;
        return json;
      }

      for (const a of json.articles) el.insertAdjacentHTML('beforeend', rexItem(a));
      return json;
    }

    async function pingHealth() {
      try {
        const res = await fetch('/health');
        if (!res.ok) throw new Error('bad status');
        const h = await res.json();
        document.getElementById('status').textContent =
          `✓ healthy · heroFeeds:${h.heroFeeds} rexFeeds:${h.rexFeeds} ` +
          `heroCached:${h.heroCached} rexCached:${h.rexCached} ` +
          `public:${h.publicFolderExists ? 'yes':'no'} index:${h.indexExists ? 'yes':'no'}`;
      } catch {
        document.getElementById('status').textContent = '⚠ health check failed';
      }
    }

    async function refreshAll() {
      try { await fetch('/api/refresh', { method: 'POST' }); } catch {}
      await Promise.all([loadHero(), loadRex(), pingHealth()]);
    }

    document.getElementById('refreshBtn').addEventListener('click', refreshAll);

    // initial load
    (async () => {
      await Promise.all([loadHero(), loadRex(), pingHealth()]);
    })();
  </script>
</body>
</html>
